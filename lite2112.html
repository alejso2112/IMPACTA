<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <title>Calling CRM | IMPACTA Business Solutions</title>
  <meta name="description" content="Lightweight calling CRM to track leads, calls, statuses, and next actions for outbound campaigns." />

  <!-- Reuse your existing styles + fonts -->
  <link rel="icon" href="img/favicon-2025.png" sizes="any" type="image/png">
  <link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">

  <style>
    /* === CRM-SPECIFIC STYLES (namespaced) === */
    :root {
      --crm-bg: #f4f7fb;
      --crm-border: #d4e1f0;
      --crm-muted: #6b7a90;
      --crm-success: #1f9d55;
      --crm-warning: #e0a800;
      --crm-danger: #d9534f;
      --crm-pill-bg: #e6eef8;
    }

    body {
      background-color: #f9fbff;
    }

    .crm-layout {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.2fr);
      grid-template-rows: auto auto;
      grid-template-areas:
        "queue call"
        "form form";
      gap: 20px;
      margin-top: 32px;
      margin-bottom: 40px;
    }

    .crm-grid-queue {
      grid-area: queue;
    }

    .crm-grid-call {
      grid-area: call;
    }

    .crm-grid-form {
      grid-area: form;
    }

    @media (max-width: 1100px) {
      .crm-layout {
        grid-template-columns: 1fr;
      }
    }

    .crm-card {
      background: #ffffff;
      border-radius: 12px;
      border: 1px solid var(--crm-border);
      padding: 16px 18px;
      box-shadow: 0 6px 18px rgba(12, 98, 171, 0.04);
    }

    .crm-card h2,
    .crm-card h3,
    .crm-card h4 {
      margin-top: 0;
    }

    .crm-section-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .crm-pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 999px;
      background: var(--crm-pill-bg);
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--crm-muted);
    }

    .crm-input-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 10px;
    }

    .crm-input-group label {
      font-size: 12px;
      font-weight: 600;
      color: var(--crm-muted);
    }

    .crm-input,
    .crm-select,
    .crm-textarea {
      border-radius: 8px;
      border: 1px solid #cbd5e0;
      padding: 8px 10px;
      font-size: 14px;
      font-family: inherit;
      width: 100%;
      box-sizing: border-box;
    }

    .crm-textarea {
      resize: vertical;
      min-height: 60px;
    }

    .crm-input:focus,
    .crm-select:focus,
    .crm-textarea:focus {
      outline: none;
      border-color: #0c62ab;
      box-shadow: 0 0 0 1px rgba(12, 98, 171, 0.12);
    }

    .crm-btn {
      border-radius: 999px;
      border: none;
      padding: 8px 14px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: background 0.15s ease, box-shadow 0.15s ease, transform 0.05s ease;
      font-family: inherit;
      white-space: nowrap;
    }

    .crm-btn-primary {
      background: #0c62ab;
      color: #ffffff;
    }
    .crm-btn-primary:hover {
      background: #0b5899;
      box-shadow: 0 6px 18px rgba(12, 98, 171, 0.25);
      transform: translateY(-1px);
    }

    .crm-btn-outline {
      background: transparent;
      color: #0c62ab;
      border: 1px solid #0c62ab;
    }
    .crm-btn-outline:hover {
      background: rgba(12, 98, 171, 0.06);
    }

    .crm-btn-ghost {
      background: transparent;
      border: 1px solid transparent;
      color: var(--crm-muted);
    }
    .crm-btn-ghost:hover {
      background: #f1f5fb;
    }

    .crm-btn-sm {
      padding: 4px 10px;
      font-size: 12px;
    }

    .crm-btn-group {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
    }

    .crm-tag {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      border: 1px solid var(--crm-border);
      color: var(--crm-muted);
      background: #ffffff;
    }

    .crm-tag-success {
      border-color: rgba(31, 157, 85, 0.3);
      color: var(--crm-success);
      background: rgba(31, 157, 85, 0.06);
    }

    .crm-tag-warning {
      border-color: rgba(224, 168, 0, 0.3);
      color: var(--crm-warning);
      background: rgba(224, 168, 0, 0.06);
    }

    .crm-tag-danger {
      border-color: rgba(217, 83, 79, 0.3);
      color: var(--crm-danger);
      background: rgba(217, 83, 79, 0.06);
    }

    /* Lead list */
    .crm-toolbar {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .crm-toolbar input {
      max-width: 260px;
    }

    .crm-lead-list {
      border-radius: 10px;
      border: 1px solid var(--crm-border);
      overflow: hidden;
      background: #ffffff;
      max-height: 480px;
      display: flex;
      flex-direction: column;
    }

    .crm-lead-list-header,
    .crm-lead-row {
      display: grid;
      grid-template-columns: 1.5fr 0.9fr 0.9fr 0.7fr 0.7fr;
      gap: 6px;
      padding: 6px 10px;
      font-size: 12px;
      align-items: center;
    }

    .crm-lead-list-header {
      font-weight: 700;
      background: #eef3fb;
      border-bottom: 1px solid var(--crm-border);
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .crm-lead-list-body {
      overflow-y: auto;
      max-height: 440px;
    }

    .crm-lead-row {
      border-bottom: 1px solid #edf2f7;
      cursor: pointer;
    }

    .crm-lead-row:hover {
      background: #f7fafc;
    }

    .crm-lead-row.active {
      background: #e3efff;
    }

    .crm-lead-name {
      font-weight: 600;
      font-size: 13px;
    }

    .crm-lead-company {
      font-size: 11px;
      color: var(--crm-muted);
    }

    .crm-status-pill {
      display: inline-flex;
      align-items: center;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid rgba(12, 98, 171, 0.18);
      background: rgba(12, 98, 171, 0.05);
      color: #0c62ab;
      white-space: nowrap;
    }

    .crm-status-pill.cold {
      border-color: rgba(107, 122, 144, 0.25);
      background: rgba(107, 122, 144, 0.08);
      color: var(--crm-muted);
    }

    .crm-status-pill.hot {
      border-color: rgba(31, 157, 85, 0.35);
      background: rgba(31, 157, 85, 0.07);
      color: #1f9d55;
    }

    .crm-mono {
      font-family: "SF Mono", "Roboto Mono", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
    }

    .crm-subtext {
      font-size: 11px;
      color: var(--crm-muted);
    }

    .crm-section-divider {
      height: 1px;
      background: #e2e8f0;
      margin: 8px 0 12px;
    }

    .crm-stat-row {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      margin-bottom: 4px;
      color: var(--crm-muted);
    }

    .crm-timeline {
      border-radius: 10px;
      border: 1px solid var(--crm-border);
      padding: 8px 10px;
      max-height: 220px;
      overflow-y: auto;
      background: #fdfefe;
    }

    .crm-timeline-item {
      border-left: 2px solid #0c62ab;
      padding-left: 8px;
      margin-bottom: 8px;
    }

    .crm-timeline-title {
      font-size: 12px;
      font-weight: 600;
    }

    .crm-timeline-meta {
      font-size: 11px;
      color: var(--crm-muted);
    }

    .crm-timeline-note {
      font-size: 12px;
      margin-top: 2px;
    }

    .crm-empty {
      font-size: 12px;
      color: var(--crm-muted);
      text-align: center;
      padding: 14px 4px;
    }

    .crm-badge-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #0c62ab;
    }

    .crm-flex {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .crm-flex-between {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .crm-highlight {
      background: #fffdf2;
      border-radius: 8px;
      padding: 8px 10px;
      border: 1px dashed #f6e05e;
      font-size: 12px;
      margin-top: 4px;
    }

    .crm-small-label {
      font-size: 13px;
      color: #3a4656; /* darker gray for easier reading */
      font-weight: 600;
    }

    /* Improve readability on the Call Panel */
    #crm-selected-wrapper {
      font-size: 14px;
      line-height: 1.4;
    }

    #crm-call-note,
    #crm-call-next {
      font-size: 14px;
    }

    .crm-status-pill,
    .crm-tag {
      font-size: 12px;
    }

    #crm-selected-name {
      font-size: 16px;
      font-weight: 700;
    }

    .crm-timeline {
      font-size: 13px;
    }

    /* Top CRM bar */
    .crm-topbar {
      width: 95%;
      background: #0c62ab;
      color: white;
      padding: 10px 20px;
      font-size: 15px;
      font-weight: 700;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      box-shadow: 0 3px 10px rgba(12, 98, 171, 0.35);
      margin-bottom: 20px;
      border-radius: 0 0 6px 6px;
    }

    /* Reporting modal */
    .crm-modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23,42, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .crm-modal {
      background: #ffffff;
      border-radius: 12px;
      border: 1px solid var(--crm-border);
      padding: 16px 18px;
      max-width: 560px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.45);
      font-size: 13px;
    }

    .crm-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .crm-modal-header h3 {
      margin: 0;
      font-size: 15px;
    }

    .crm-report-section-title {
      font-weight: 700;
      font-size: 12px;
      margin-top: 10px;
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--crm-muted);
    }

    .crm-report-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 8px;
    }

    .crm-report-table th,
    .crm-report-table td {
      padding: 4px 6px;
      border-bottom: 1px solid #edf2f7;
      font-size: 12px;
      text-align: left;
    }

    .crm-report-table th {
      background: #f7fafc;
      font-weight: 600;
    }

    .crm-report-badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      background: #edf2ff;
      border: 1px solid rgba(129, 140, 248, 0.4);
      font-size: 11px;
    }
  </style>

  <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script>
    const SUPABASE_URL = 'https://fxpgkqzwmrnrjropwbgy.supabase.co';
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ4cGdrcXp3bXJucmpyb3B3Ymd5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwMzIwNjUsImV4cCI6MjA3OTYwODA2NX0.xTh99CedsaDKIj1IZMk_0lbYq1B9kpvdeYpxDNc4Mi0";

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>

</head>
<body>
  <!-- Header reused from your main site -->
  <header>
    <div class="container nav" role="navigation" aria-label="Main navigation">
    </div>
  </header>

  <div class="crm-section-title">
    <div class="brand">
      <a href="index.html">
        <img src="img/logo-mobile-2025.png" alt="IMPACTA Business Solutions Logo - Growth Partner" style="width: 300px;" class="logo-desktop">
      </a>
    </div>
    <div style="flex:1; display:flex; flex-direction:column; align-items:center; gap:6px;">
      <div class="crm-pill">Calling CRM • Internal Tool</div>
      <div class="crm-topbar" role="banner" aria-label="Calling CRM header"
           style="display:flex;justify-content:center;align-items:center;gap:12px;flex-wrap:wrap;">
        <div style="display:flex;align-items:center;gap:12px;">
          <img src="img/logo-mobile-2025.png" alt="" style="height:28px;opacity:0.95;">
          <div style="line-height:1;text-align:center;">
            <div style="font-size:16px;font-weight:700;">Outbound Calling Workspace</div>
            <div style="font-size:12px;opacity:0.9;">Lightweight CRM for outbound campaigns</div>
          </div>
        </div>

        <div style="display:flex;gap:8px;align-items:center;">
          <button id="crm-import" class="crm-btn crm-btn-ghost crm-btn-sm" title="Import leads (JSON)">Import</button>
          <button id="crm-clear-storage" class="crm-btn crm-btn-outline crm-btn-sm" title="Clear all local data">Clear Data</button>
        </div>
      </div>
    </div>
    <div class="crm-flex" style="font-size:14px;">
      <span class="crm-small-label" style="font-size:13px;">Today:</span>
      <span id="crm-today" class="crm-mono" style="font-size:14px;">Nov 23, 2025</span>
    </div>
  </div>

  <div class="crm-layout">
    <!-- MIDDLE & RIGHT: Lead Queue + Call Panel -->
    <!-- MIDDLE: Lead list & quick stats -->
    <section class="crm-card crm-grid-queue" aria-label="Lead list and stats">
      <div class="crm-section-title">
        <h2 style="font-size: 16px;">Lead Queue</h2>
        <span class="crm-small-label">
          Total: <strong id="crm-total-count">0</strong>
        </span>
      </div>

      <div class="crm-toolbar" aria-label="Filters">
        <input
          id="crm-search"
          class="crm-input"
          type="search"
          placeholder="Search name, company, or phone..."
        />
        <select id="crm-filter-status" class="crm-select" style="max-width: 170px;">
          <option value="">All Statuses</option>
          <option value="New">New</option>
          <option value="Working">Working</option>
          <option value="No Answer">No Answer</option>
          <option value="Left Voicemail">Left Voicemail</option>
          <option value="Follow-Up">Follow-Up</option>
          <option value="Booked Meeting">Booked Meeting</option>
          <option value="Closed Won">Closed Won</option>
          <option value="Closed Lost">Closed Lost</option>
          <option value="Not a Fit">Not a Fit</option>
        </select>
        <select id="crm-filter-priority" class="crm-select" style="max-width: 130px;">
          <option value="">All Priorities</option>
          <option value="High">High</option>
          <option value="Normal">Normal</option>
          <option value="Low">Low</option>
        </select>

        <!-- Calling View toggle + date range -->
        <label class="crm-small-label" style="display:flex;align-items:center;gap:4px;">
          <input type="checkbox" id="crm-calling-toggle" style="margin:0;">
          Calling View
        </label>

        <div id="crm-calling-range" style="display:none;">
          <span class="crm-small-label">From</span>
          <input type="date" id="crm-callview-from" class="crm-input crm-input-date-range">
          <span class="crm-small-label">To</span>
          <input type="date" id="crm-callview-to" class="crm-input crm-input-date-range">
        </div>
      </div>

      <div class="crm-lead-list">
        <div class="crm-lead-list-header">
          <div>Contact</div>
          <div>Phone</div>
          <div>Status</div>
          <div>Next Call</div>
          <div>Priority</div>
        </div>
        <div id="crm-lead-list-body" class="crm-lead-list-body">
          <div class="crm-empty">No leads yet. Add one on the left.</div>
        </div>
      </div>

      <div class="crm-section-divider"></div>

      <div>
        <h3 style="font-size: 13px; margin-bottom: 8px;">Today Snapshot</h3>
        <div class="crm-stat-row">
          <span>Calls Logged</span>
          <span class="crm-mono" id="crm-today-calls">0</span>
        </div>
        <div class="crm-stat-row">
          <span>Meetings Booked</span>
          <span class="crm-mono" id="crm-today-meetings">0</span>
        </div>
        <div class="crm-stat-row">
          <span>Follow-Ups Due (today+past)</span>
          <span class="crm-mono" id="crm-today-followups">0</span>
        </div>
      </div>

      <div class="crm-section-divider"></div>

      <!-- Analytics block -->
      <div>
        <div class="crm-flex-between" style="margin-bottom:6px;">
          <h3 style="font-size: 13px; margin:0;">Analytics</h3>
          <button type="button" id="crm-report-open" class="crm-btn crm-btn-ghost crm-btn-sm">
            View Detailed Report
          </button>
        </div>
        <div class="crm-stat-row">
          <span>Total Leads (all time)</span>
          <span class="crm-mono" id="crm-analytics-total">0</span>
        </div>
        <div class="crm-stat-row">
          <span>Active Pipeline (New / Working / Follow-Up)</span>
          <span class="crm-mono" id="crm-analytics-active">0</span>
        </div>
        <div class="crm-stat-row">
          <span>Meetings Booked (lifetime)</span>
          <span class="crm-mono" id="crm-analytics-ltm-meetings">0</span>
        </div>
        <div class="crm-stat-row">
          <span>Closed Won</span>
          <span class="crm-mono" id="crm-analytics-closed-won">0</span>
        </div>
        <div class="crm-stat-row">
          <span>Closed Lost / Not a Fit</span>
          <span class="crm-mono" id="crm-analytics-closed-lost">0</span>
        </div>
        <div class="crm-stat-row">
          <span>Avg Calls per Lead</span>
          <span class="crm-mono" id="crm-analytics-avg-calls">0</span>
        </div>
      </div>
    </section>

    <!-- RIGHT: Selected lead + call logging -->
    <section class="crm-card crm-grid-call" aria-label="Selected lead and call logging">
      <div class="crm-section-title">
        <h2 style="font-size: 16px;">Call Panel</h2>
        <span class="crm-small-label" id="crm-selected-label">No lead selected</span>
      </div>

      <div class="crm-highlight" id="crm-call-hint">
        Select a lead from the middle panel to start logging calls and notes.
      </div>

      <div id="crm-selected-wrapper" style="display:none;">
        <div class="crm-section-divider"></div>
        <div class="crm-flex-between">
          <div>
            <div class="crm-flex">
              <div class="crm-badge-dot"></div>
              <div>
                <div id="crm-selected-name" style="font-weight: 600;"></div>
                <div id="crm-selected-company" class="crm-subtext"></div>
              </div>
            </div>
          </div>
          <div style="text-align:right;">
            <div id="crm-selected-status-pill" class="crm-status-pill">Status</div>
            <div id="crm-selected-priority" class="crm-subtext"></div>
          </div>
        </div>

        <div style="margin-top:10px; font-size: 12px;">
          <div>
            <span class="crm-small-label">Phone:</span>
            <span class="crm-mono" id="crm-selected-phone"></span>
          </div>
          <div>
            <span class="crm-small-label">Email:</span>
            <span id="crm-selected-email" class="crm-mono"></span>
          </div>
          <div>
            <span class="crm-small-label">Website:</span>
            <a id="crm-selected-website"
               class="crm-mono"
               href="#"
               target="_blank"
               rel="noopener noreferrer"
               style="text-decoration:underline; cursor:pointer;"></a>
          </div>
          <div>
            <span class="crm-small-label">Next Call:</span>
            <span id="crm-selected-next" class="crm-mono"></span>
          </div>
        </div>

        <div class="crm-section-divider"></div>

        <div>
          <h3 style="font-size: 13px; margin-bottom: 6px;">Log Call</h3>
          <div class="crm-btn-group">
            <button type="button" class="crm-btn crm-btn-sm crm-btn-outline crm-call-outcome" data-outcome="No Answer">
              No Answer
            </button>
            <button type="button" class="crm-btn crm-btn-sm crm-btn-outline crm-call-outcome" data-outcome="Left Voicemail">
              Left VM
            </button>
            <button type="button" class="crm-btn crm-btn-sm crm-btn-outline crm-call-outcome" data-outcome="Booked Meeting">
              Booked Meeting
            </button>
            <button type="button" class="crm-btn crm-btn-sm crm-btn-outline crm-call-outcome" data-outcome="Not Interested">
              Not Interested
            </button>
            <button type="button" class="crm-btn crm-btn-sm crm-btn-outline crm-call-outcome" data-outcome="Callback Requested">
              Callback Req.
            </button>
          </div>

          <div class="crm-input-group" style="margin-top:4px;">
            <label for="crm-call-note">Call Notes</label>
            <textarea id="crm-call-note" class="crm-textarea" placeholder="Short notes from the call..."></textarea>
          </div>

          <div style="display:flex; gap:8px; align-items:center; margin-bottom:6px;">
            <div class="crm-input-group" style="flex: 1; margin-bottom:0;">
              <label for="crm-call-next">Next Call (optional)</label>
              <input id="crm-call-next" type="datetime-local" class="crm-input" />
            </div>
            <button type="button" id="crm-call-save" class="crm-btn crm-btn-primary crm-btn-sm" style="align-self:flex-end; margin-bottom:2px;">
              Save Log
            </button>
          </div>
        </div>

        <div class="crm-section-divider"></div>

        <div>
          <h3 style="font-size: 13px; margin-bottom: 6px;">Timeline</h3>
          <div id="crm-timeline" class="crm-timeline">
            <div class="crm-empty">No calls logged yet.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- BOTTOM: New / Edit Lead -->
    <!-- LEFT: Add / edit lead -->
    <aside class="crm-card crm-grid-form" aria-label="Add or edit lead form">
      <div class="crm-section-title">
        <h2 style="font-size: 16px;">New / Edit Lead</h2>
        <span class="crm-tag" id="crm-form-mode-tag">New</span>
      </div>
      <div class="crm-section-divider"></div>

      <form id="lead-form">
        <input type="hidden" id="lead-id" />

        <!-- First & Last Name split -->
        <div style="display:flex; gap:10px;">
          <div class="crm-input-group" style="flex:1;">
            <label for="lead-first-name">First Name *</label>
            <input class="crm-input" id="lead-first-name" name="firstName" type="text" placeholder="Jane" required />
          </div>
          <div class="crm-input-group" style="flex:1;">
            <label for="lead-last-name">Last Name</label>
            <input class="crm-input" id="lead-last-name" name="lastName" type="text" placeholder="Doe" />
          </div>
        </div>

        <div class="crm-input-group">
          <label for="lead-company">Company</label>
          <input class="crm-input" id="lead-company" name="company" type="text" placeholder="Acme Cleaning Services" />
        </div>

        <div class="crm-input-group">
          <label for="lead-phone">Phone *</label>
          <input class="crm-input" id="lead-phone" name="phone" type="tel" placeholder="+1 (352) 555-0123" required />
        </div>

        <div class="crm-input-group">
          <label for="lead-email">Email</label>
          <input class="crm-input" id="lead-email" name="email" type="email" placeholder="name@business.com" />
        </div>

        <!-- Website field -->
        <div class="crm-input-group">
          <label for="lead-website">Website</label>
          <input class="crm-input" id="lead-website" name="website" type="text" placeholder="acmecleaning.com" />
        </div>

        <div class="crm-input-group">
          <label for="lead-source">Source</label>
          <input class="crm-input" id="lead-source" name="source" type="text" placeholder="List: Ocala Commercial, Webform, Referral..." />
        </div>

        <div style="display:flex; gap:10px;">
          <div class="crm-input-group" style="flex:1;">
            <label for="lead-status">Status</label>
            <select class="crm-select" id="lead-status" name="status">
              <option value="New">New</option>
              <option value="Working">Working</option>
              <option value="No Answer">No Answer</option>
              <option value="Left Voicemail">Left Voicemail</option>
              <option value="Follow-Up">Follow-Up</option>
              <option value="Booked Meeting">Booked Meeting</option>
              <option value="Closed Won">Closed Won</option>
              <option value="Closed Lost">Closed Lost</option>
              <option value="Not a Fit">Not a Fit</option>
            </select>
          </div>
          <div class="crm-input-group" style="flex:1;">
            <label for="lead-priority">Priority</label>
            <select class="crm-select" id="lead-priority" name="priority">
              <option value="Normal">Normal</option>
              <option value="High">High</option>
              <option value="Low">Low</option>
            </select>
          </div>
        </div>

        <div style="display:flex; gap:10px;">
          <div class="crm-input-group" style="flex:1;">
            <label for="lead-timezone">Timezone</label>
            <select class="crm-select" id="lead-timezone" name="timezone">
              <option value="">Not set</option>
              <option value="EST">EST</option>
              <option value="CST">CST</option>
              <option value="MST">MST</option>
              <option value="PST">PST</option>
            </select>
          </div>
          <div class="crm-input-group" style="flex:1;">
            <label for="lead-next-call">Next Call</label>
            <input class="crm-input" id="lead-next-call" name="nextCall" type="datetime-local" />
          </div>
        </div>

        <div class="crm-input-group">
          <label for="lead-notes">Notes / Context</label>
          <textarea class="crm-textarea" id="lead-notes" name="notes" placeholder="Notes from previous convos, context, objections, etc."></textarea>
        </div>

        <div class="crm-flex-between" style="margin-top: 10px;">
          <div class="crm-btn-group">
            <button type="submit" class="crm-btn crm-btn-primary">
              <span id="crm-form-submit-label">Save Lead</span>
            </button>
            <button type="button" id="crm-form-reset" class="crm-btn crm-btn-ghost crm-btn-sm">
              Clear
            </button>
          </div>
          <button type="button" id="crm-export" class="crm-btn crm-btn-outline crm-btn-sm">
            Export JSON
          </button>
        </div>
      </form>
    </aside>
  </div>
  <!-- Sign In -->
  <div id="crm-auth-bar" class="crm-card" style="max-width:600px;margin:16px auto 0;">
    <div class="crm-section-title">
      <h2 style="font-size:15px;margin:0;">Rep Login</h2>
      <span id="crm-auth-status" class="crm-small-label">Not signed in</span>
    </div>
    <div class="crm-section-divider"></div>
    <div id="crm-auth-logged-out" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
      <input id="crm-auth-email" type="email" class="crm-input" placeholder="rep@impactabusiness.solutions"
            style="max-width:220px;">
      <input id="crm-auth-password" type="password" class="crm-input" placeholder="Password"
            style="max-width:180px;">
      <button id="crm-auth-login" class="crm-btn crm-btn-primary crm-btn-sm">Sign In</button>
    </div>
    <div id="crm-auth-logged-in" style="display:none;align-items:center;justify-content:space-between;gap:8px;">
      <span class="crm-small-label">Signed in as <span id="crm-auth-email-label"></span></span>
      <button id="crm-auth-logout" class="crm-btn crm-btn-ghost crm-btn-sm">Sign Out</button>
    </div>
  </div>
  <!-- Reporting Modal -->
  <div id="crm-report-modal" class="crm-modal-backdrop" aria-hidden="true">
    <div class="crm-modal" role="dialog" aria-modal="true" aria-labelledby="crm-report-title">
      <div class="crm-modal-header">
        <h3 id="crm-report-title">Detailed Reporting</h3>
        <button type="button" id="crm-report-close" class="crm-btn crm-btn-ghost crm-btn-sm">Close</button>
      </div>
      <div id="crm-report-body">
        <!-- Filled by JS -->
      </div>
    </div>
  </div>

  <footer class="container" role="contentinfo">
    <div style="display:flex;flex-direction:column;gap:8px">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <div>
          <strong>IMPACTA Business Solutions Inc.</strong><br />
          <span class="small muted"> Owned and Operated in Ocala, FL, USA</span>
        </div>
        <div style="display:flex;gap:10px;align-items:center">
          <a class="small muted" href="mailto:support@impactabusiness.solutions">getsupport@impactabusiness.solutions</a>
          <a class="small muted" href="tel:+13523891832">(352) 389-1832</a>
        </div>
      </div>

      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <div class="small muted">© 2025 IMPACTA Business Solutions Inc. All rights reserved.</div>
        <div style="display:flex;gap:12px">
          <a class="small muted" href="privacy.html">Privacy Policy</a>
          <a class="small muted" href="terms.html">Terms of Service</a>
        </div>
      </div>
    </div>
  </footer>

  <script>
// --- CSV IMPORTER ---
document.getElementById("crm-import").addEventListener("click", function () {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = ".csv";

  input.onchange = function (event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();

    reader.onload = function (e) {
      try {
        const text = e.target.result;

        // Parse CSV → Array of objects
        const rows = text.trim().split("\n");
        const headers = rows.shift().split(",").map(h => h.trim());

        const imported = rows.map(row => {
          const values = row.split(",").map(v => v.trim());
          const obj = {};
          headers.forEach((h, i) => (obj[h] = values[i] || ""));
          return obj;
        });

        // Convert CSV → CRM lead format
        const normalized = imported.map((r) => ({
          id: crypto.randomUUID(),
          firstName: r.firstName || "",
          lastName: r.lastName || "",
          name: `${r.firstName || ""} ${r.lastName || ""}`.trim(),
          company: r.company || "",
          phone: r.phone || "",
          email: r.email || "",
          website: r.website || "",
          source: r.source || "",
          status: r.status || "New",
          priority: r.priority || "Normal",
          timezone: "",
          nextCall: r.nextCall || "",
          notes: r.notes || "",
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString(),
          timeline: []
        }));

        // If logged in, also send to Supabase
        if (currentUser) {
          normalized.forEach(async (lead) => {
            await upsertLeadToSupabase(lead);
          });
        }

        // Add to local CRM
        leads = leads.concat(normalized);
        saveLeads();
        renderLeadList();
        resetForm();

        alert("CSV imported successfully!");
      } catch (err) {
        console.error(err);
        alert("Could not read CSV file. Make sure the format is correct.");
      }
    };

    reader.readAsText(file);
  };

  input.click();
});

// Export JSON
document.getElementById("crm-export").addEventListener("click", function () {
  const dataStr =
    "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(leads, null, 2));
  const a = document.createElement("a");
  a.setAttribute("href", dataStr);
  a.setAttribute("download", "impacta-calling-crm.json");
  document.body.appendChild(a);
  a.click();
  a.remove();
});

let currentUser = null;
// === Simple Calling CRM (localStorage only) ===
(function () {
  const STORAGE_KEY = "impacta_calling_crm_v1";

  /** @type {Array} */
  let leads = [];
  let selectedId = null;

  // --- Helpers ---
  function saveLeads() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(leads));
    updateCountsAndSnapshot();
  }

  function loadLeads() {
    const raw = localStorage.getItem(STORAGE_KEY);
    leads = raw ? JSON.parse(raw) : [];
  }

  // --- Supabase helpers ---
  // Load leads from Supabase for the current authenticated user. When no user is
  // signed in, this function returns without modifying the leads array. It
  // transforms each row into the format expected by the CRM and triggers
  // rendering and count updates.
  async function loadLeadsFromSupabase() {
    if (!currentUser) return;
    const { data, error } = await supabaseClient
      .from("leads")
      .select("*")
      .eq("user_id", currentUser.id)
      .order("created_at", { ascending: false });

    if (error) {
      console.error("Error loading leads:", error);
      alert("Error loading leads from server.");
      return;
    }

    leads = (data || []).map((row) => ({
      id: row.id,
      firstName: row.first_name,
      lastName: row.last_name,
      name: row.name,
      company: row.company,
      phone: row.phone,
      email: row.email,
      website: row.website,
      source: row.source,
      status: row.status,
      priority: row.priority,
      timezone: row.timezone,
      nextCall: row.next_call,
      notes: row.notes,
      createdAt: row.created_at,
      updatedAt: row.updated_at,
      timeline: row.timeline || []
    }));

    renderLeadList();
    updateCountsAndSnapshot();
  }

  // Upsert a lead record to Supabase. Inserts a new row or updates an existing
  // one based on the lead's id. When no user is signed in, it returns early.
  async function upsertLeadToSupabase(lead) {
    if (!currentUser) return;

    const payload = {
      id: lead.id,
      user_id: currentUser.id,
      first_name: lead.firstName || null,
      last_name: lead.lastName || null,
      name: lead.name || null,
      company: lead.company || null,
      phone: lead.phone || null,
      email: lead.email || null,
      website: lead.website || null,
      source: lead.source || null,
      status: lead.status || null,
      priority: lead.priority || null,
      timezone: lead.timezone || null,
      next_call: lead.nextCall || null,
      notes: lead.notes || null,
      timeline: lead.timeline || []
    };

    const { error } = await supabaseClient
      .from("leads")
      .upsert(payload, { onConflict: "id" });

    if (error) {
      console.error("Error saving lead:", error);
      alert("Error saving lead to server.");
    }
  }

  function uid() {
    return "L" + Math.random().toString(36).slice(2, 10) + Date.now().toString(36).slice(-4);
  }

  function formatDateTime(dtStr) {
    if (!dtStr) return "";
    const d = new Date(dtStr);
    if (isNaN(d.getTime())) return dtStr;
    return d.toLocaleString(undefined, {
      month: "short",
      day: "numeric",
      hour: "2-digit",
      minute: "2-digit"
    });
  }

  function todayString() {
    const d = new Date();
    return d.toLocaleString(undefined, {
      year: "numeric",
      month: "short",
      day: "numeric",
      hour: "2-digit",
      minute: "2-digit"
    });
  }

  function getTodayISODate() {
    const d = new Date();
    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return year + "-" + month + "-" + day;
  }

  function isSameDay(a, b) {
    return (
      a.getFullYear() === b.getFullYear() &&
      a.getMonth() === b.getMonth() &&
      a.getDate() === b.getDate()
    );
  }

  function renderTodayLabel() {
    const el = document.getElementById("crm-today");
    if (el) el.textContent = todayString();
  }

  // --- Reporting helpers ---
  function computeReportData() {
    const statusCounts = {};
    const outcomeCounts = {};
    const sourceCounts = {};
    let totalCalls = 0;

    for (const lead of leads) {
      const status = lead.status || "Unspecified";
      statusCounts[status] = (statusCounts[status] || 0) + 1;

      const src = lead.source && lead.source.trim() ? lead.source.trim() : "Unspecified";
      sourceCounts[src] = (sourceCounts[src] || 0) + 1;

      for (const entry of lead.timeline || []) {
        const outcome = entry.outcome || "Update";
        outcomeCounts[outcome] = (outcomeCounts[outcome] || 0) + 1;
        totalCalls++;
      }
    }

    return { statusCounts, outcomeCounts, sourceCounts, totalCalls };
  }

  function renderReportModal() {
    const modal = document.getElementById("crm-report-modal");
    const body = document.getElementById("crm-report-body");
    if (!modal || !body) return;

    const { statusCounts, outcomeCounts, sourceCounts, totalCalls } = computeReportData();

    let html = "";

    html += '<div class="crm-report-section-title">Overview</div>';
    html += '<p style="margin:4px 0 8px;">';
    html += '<span class="crm-report-badge">Total Leads: ' + leads.length + "</span>";
    html += " &nbsp; ";
    html += '<span class="crm-report-badge">Total Call Logs: ' + totalCalls + "</span>";
    html += "</p>";

    // Status table
    html += '<div class="crm-report-section-title">Leads by Status</div>';
    if (Object.keys(statusCounts).length) {
      html +=
        '<table class="crm-report-table"><thead><tr><th>Status</th><th>Count</th></tr></thead><tbody>';
      Object.keys(statusCounts)
        .sort()
        .forEach((key) => {
          html += "<tr><td>" + key + "</td><td>" + statusCounts[key] + "</td></tr>";
        });
      html += "</tbody></table>";
    } else {
      html += '<div class="crm-empty" style="padding:6px 0;">No leads yet.</div>';
    }

    // Outcome table
    html += '<div class="crm-report-section-title">Call Outcomes</div>';
    if (Object.keys(outcomeCounts).length) {
      html +=
        '<table class="crm-report-table"><thead><tr><th>Outcome</th><th>Count</th></tr></thead><tbody>';
      Object.keys(outcomeCounts)
        .sort()
        .forEach((key) => {
          html += "<tr><td>" + key + "</td><td>" + outcomeCounts[key] + "</td></tr>";
        });
      html += "</tbody></table>";
    } else {
      html += '<div class="crm-empty" style="padding:6px 0;">No calls logged yet.</div>';
    }

    // Source table (top sources)
    html += '<div class="crm-report-section-title">Leads by Source</div>';
    if (Object.keys(sourceCounts).length) {
      const sortedSources = Object.keys(sourceCounts).sort(
        (a, b) => sourceCounts[b] - sourceCounts[a]
      );
      html +=
        '<table class="crm-report-table"><thead><tr><th>Source</th><th>Count</th></tr></thead><tbody>';
      sortedSources.forEach((key) => {
        html += "<tr><td>" + key + "</td><td>" + sourceCounts[key] + "</td></tr>";
      });
      html += "</tbody></table>";
    } else {
      html += '<div class="crm-empty" style="padding:6px 0;">No sources recorded yet.</div>';
    }

    body.innerHTML = html;
    modal.style.display = "flex";
    modal.setAttribute("aria-hidden", "false");
  }

  function hideReportModal() {
    const modal = document.getElementById("crm-report-modal");
    if (!modal) return;
    modal.style.display = "none";
    modal.setAttribute("aria-hidden", "true");
  }

  // --- Rendering: List ---
  function renderLeadList() {
    const body = document.getElementById("crm-lead-list-body");
    const totalCountEl = document.getElementById("crm-total-count");
    if (!body) return;

    body.innerHTML = "";

    const searchTerm = document.getElementById("crm-search").value.trim().toLowerCase();

    const filterStatus = document.getElementById("crm-filter-status").value;
    const filterPriority = document.getElementById("crm-filter-priority").value;

    // Calling View controls
    const callingToggleEl = document.getElementById("crm-calling-toggle");
    const fromEl = document.getElementById("crm-callview-from");
    const toEl = document.getElementById("crm-callview-to");

    const callingEnabled = callingToggleEl ? callingToggleEl.checked : false;

    let fromDate = null;
    let toDate = null;

    if (callingEnabled && fromEl && fromEl.value) {
      const fd = new Date(fromEl.value + "T00:00:00");
      if (!isNaN(fd.getTime())) fromDate = fd;
    }
    if (callingEnabled && toEl && toEl.value) {
      const td = new Date(toEl.value + "T23:59:59");
      if (!isNaN(td.getTime())) toDate = td;
    }

    // If both set and from > to, swap them
    if (fromDate && toDate && fromDate > toDate) {
      const tmp = fromDate;
      fromDate = toDate;
      toDate = tmp;
    }

    const filtered = leads.filter((lead) => {
      // Status / priority filters
      if (filterStatus && lead.status !== filterStatus) return false;
      if (filterPriority && lead.priority !== filterPriority) return false;

      // Search term (include website and first/last)
      if (searchTerm) {
        const haystack = [
          lead.name || "",
          lead.firstName || "",
          lead.lastName || "",
          lead.company || "",
          lead.phone || "",
          lead.email || "",
          lead.website || ""
        ]
          .join(" ")
          .toLowerCase();
        if (!haystack.includes(searchTerm)) return false;
      }

      // Calling view filter by recall date (nextCall)
      if (callingEnabled) {
        if (!lead.nextCall) return false;
        const nd = new Date(lead.nextCall);
        if (isNaN(nd.getTime())) return false;
        if (fromDate && nd < fromDate) return false;
        if (toDate && nd > toDate) return false;
      }

      return true;
    });

    if (totalCountEl) totalCountEl.textContent = leads.length.toString();

    if (!filtered.length) {
      const empty = document.createElement("div");
      empty.className = "crm-empty";
      empty.textContent = callingEnabled
        ? "No leads with recall dates in this range."
        : "No leads match your filters.";
      body.appendChild(empty);
      return;
    }

    // Sort by nextCall ascending, with empty nextCall at bottom
    filtered.sort((a, b) => {
      if (!a.nextCall && !b.nextCall) return 0;
      if (!a.nextCall) return 1;
      if (!b.nextCall) return -1;
      return new Date(a.nextCall) - new Date(b.nextCall);
    });

    for (const lead of filtered) {
      const row = document.createElement("div");
      row.className = "crm-lead-row";
      if (lead.id === selectedId) {
        row.classList.add("active");
      }
      row.dataset.id = lead.id;

      const nameCell = document.createElement("div");
      const nameDiv = document.createElement("div");
      nameDiv.className = "crm-lead-name";
      nameDiv.textContent = lead.name || "(No name)";
      const companyDiv = document.createElement("div");
      companyDiv.className = "crm-lead-company";
      companyDiv.textContent = lead.company || lead.source || "";
      nameCell.appendChild(nameDiv);
      nameCell.appendChild(companyDiv);

      const phoneCell = document.createElement("div");
      phoneCell.className = "crm-mono";
      phoneCell.textContent = lead.phone || "";

      const statusCell = document.createElement("div");
      const statusPill = document.createElement("span");
      statusPill.className = "crm-status-pill";
      const hotStatuses = ["Booked Meeting", "Closed Won", "Follow-Up"];
      const coldStatuses = ["Closed Lost", "Not a Fit"];
      if (hotStatuses.includes(lead.status)) statusPill.classList.add("hot");
      if (coldStatuses.includes(lead.status)) statusPill.classList.add("cold");
      statusPill.textContent = lead.status || "New";
      statusCell.appendChild(statusPill);

      const nextCell = document.createElement("div");
      nextCell.className = "crm-mono";
      nextCell.textContent = formatDateTime(lead.nextCall);

      const priorityCell = document.createElement("div");
      const priorityTag = document.createElement("span");
      priorityTag.className = "crm-tag";
      if (lead.priority === "High") priorityTag.classList.add("crm-tag-danger");
      if (lead.priority === "Low") priorityTag.classList.add("crm-tag-warning");
      priorityTag.textContent = lead.priority || "Normal";
      priorityCell.appendChild(priorityTag);

      row.appendChild(nameCell);
      row.appendChild(phoneCell);
      row.appendChild(statusCell);
      row.appendChild(nextCell);
      row.appendChild(priorityCell);

      row.addEventListener("click", () => {
        selectLead(lead.id);
      });

      body.appendChild(row);
    }
  }

  // --- Rendering: Selected lead + timeline ---
  function selectLead(id) {
    selectedId = id;
    const wrapper = document.getElementById("crm-selected-wrapper");
    const hint = document.getElementById("crm-call-hint");
    const label = document.getElementById("crm-selected-label");
    const rowContainer = document.getElementById("crm-lead-list-body");

    if (!wrapper || !label || !rowContainer) return;

    const lead = leads.find((l) => l.id === id);
    if (!lead) return;

    wrapper.style.display = "";
    if (hint) hint.style.display = "none";
    label.textContent = "Active Lead";

    // Name / company
    document.getElementById("crm-selected-name").textContent = lead.name || "(No name)";
    document.getElementById("crm-selected-company").textContent =
      lead.company || lead.source || "";

    // Status pill
    const pill = document.getElementById("crm-selected-status-pill");
    pill.textContent = lead.status || "New";
    pill.className = "crm-status-pill";
    const hotStatuses = ["Booked Meeting", "Closed Won", "Follow-Up"];
    const coldStatuses = ["Closed Lost", "Not a Fit"];
    if (hotStatuses.includes(lead.status)) pill.classList.add("hot");
    if (coldStatuses.includes(lead.status)) pill.classList.add("cold");

    // Priority
    const priorityEl = document.getElementById("crm-selected-priority");
    priorityEl.textContent = "Priority: " + (lead.priority || "Normal");

    // Phone / email / website / next
    document.getElementById("crm-selected-phone").textContent = lead.phone || "";
    document.getElementById("crm-selected-email").textContent = lead.email || "";

    const websiteEl = document.getElementById("crm-selected-website");
    if (websiteEl) {
      if (lead.website) {
        let url = lead.website.trim();
        if (url && !/^https?:\/\//i.test(url)) {
          url = "https://" + url;
        }
        websiteEl.textContent = url;
        websiteEl.href = url;
        websiteEl.style.pointerEvents = "auto";
        websiteEl.style.opacity = "1";
      } else {
        websiteEl.textContent = "";
        websiteEl.removeAttribute("href");
        websiteEl.style.pointerEvents = "none";
        websiteEl.style.opacity = "0.6";
      }
    }

    document.getElementById("crm-selected-next").textContent = formatDateTime(lead.nextCall);

    // Reset call note + next
    document.getElementById("crm-call-note").value = "";
    document.getElementById("crm-call-next").value = "";

    // Highlight active row
    for (const row of rowContainer.querySelectorAll(".crm-lead-row")) {
      row.classList.toggle("active", row.dataset.id === id);
    }

    renderTimeline(lead);
    // Also sync form with selected lead for edits
    fillFormWithLead(lead);
  }

  function renderTimeline(lead) {
    const timelineEl = document.getElementById("crm-timeline");
    if (!timelineEl) return;
    timelineEl.innerHTML = "";

    const entries = (lead.timeline || []).slice().sort((a, b) => {
      return new Date(b.timestamp) - new Date(a.timestamp);
    });

    if (!entries.length) {
      const empty = document.createElement("div");
      empty.className = "crm-empty";
      empty.textContent = "No calls logged yet.";
      timelineEl.appendChild(empty);
      return;
    }

    for (const entry of entries) {
      const item = document.createElement("div");
      item.className = "crm-timeline-item";

      const title = document.createElement("div");
      title.className = "crm-timeline-title";
      title.textContent = entry.outcome || "Note";

      const meta = document.createElement("div");
      meta.className = "crm-timeline-meta";
      meta.textContent = new Date(entry.timestamp).toLocaleString();

      item.appendChild(title);
      item.appendChild(meta);

      if (entry.note) {
        const note = document.createElement("div");
        note.className = "crm-timeline-note";
        note.textContent = entry.note;
        item.appendChild(note);
      }

      timelineEl.appendChild(item);
    }
  }

  function fillFormWithLead(lead) {
    document.getElementById("lead-id").value = lead.id;

    const fullName = lead.name || "";
    let first = lead.firstName || "";
    let last = lead.lastName || "";

    if (!first && fullName) {
      const parts = fullName.split(" ");
      first = parts[0] || "";
      last = parts.slice(1).join(" ");
    }

    document.getElementById("lead-first-name").value = first || "";
    document.getElementById("lead-last-name").value = last || "";

    document.getElementById("lead-company").value = lead.company || "";
    document.getElementById("lead-phone").value = lead.phone || "";
    document.getElementById("lead-email").value = lead.email || "";
    document.getElementById("lead-website").value = lead.website || "";
    document.getElementById("lead-source").value = lead.source || "";
    document.getElementById("lead-status").value = lead.status || "New";
    document.getElementById("lead-priority").value = lead.priority || "Normal";
    document.getElementById("lead-timezone").value = lead.timezone || "";
    document.getElementById("lead-next-call").value = lead.nextCall || "";
    document.getElementById("lead-notes").value = lead.notes || "";
    document.getElementById("crm-form-mode-tag").textContent = "Editing";
    document.getElementById("crm-form-submit-label").textContent = "Update Lead";
  }

  function resetForm() {
    selectedId = null;
    document.getElementById("lead-id").value = "";
    document.getElementById("lead-first-name").value = "";
    document.getElementById("lead-last-name").value = "";
    document.getElementById("lead-company").value = "";
    document.getElementById("lead-phone").value = "";
    document.getElementById("lead-email").value = "";
    document.getElementById("lead-website").value = "";
    document.getElementById("lead-source").value = "";
    document.getElementById("lead-status").value = "New";
    document.getElementById("lead-priority").value = "Normal";
    document.getElementById("lead-timezone").value = "";
    document.getElementById("lead-next-call").value = "";
    document.getElementById("lead-notes").value = "";
    document.getElementById("crm-form-mode-tag").textContent = "New";
    document.getElementById("crm-form-submit-label").textContent = "Save Lead";

    const wrapper = document.getElementById("crm-selected-wrapper");
    const hint = document.getElementById("crm-call-hint");
    const label = document.getElementById("crm-selected-label");
    const timeline = document.getElementById("crm-timeline");
    const rowContainer = document.getElementById("crm-lead-list-body");

    if (wrapper && hint && label && timeline && rowContainer) {
      wrapper.style.display = "none";
      hint.style.display = "";
      label.textContent = "No lead selected";
      timeline.innerHTML = '<div class="crm-empty">No calls logged yet.</div>';

      for (const row of rowContainer.querySelectorAll(".crm-lead-row")) {
        row.classList.remove("active");
      }
    }
  }
})();


      // --- Counts, snapshot & analytics ---
      function updateCountsAndSnapshot() {
        const today = new Date();
        let callsToday = 0;
        let meetingsToday = 0;
        let dueFollowUps = 0;

        // Analytics aggregates
        const totalLeads = leads.length;
        let activePipeline = 0;
        let lifetimeMeetings = 0;
        let closedWon = 0;
        let closedLost = 0;
        let totalCallLogs = 0;

        const activeStatuses = ["New", "Working", "Follow-Up"];

        for (const lead of leads) {
          // Status-based analytics
          if (activeStatuses.includes(lead.status)) activePipeline++;
          if (lead.status === "Closed Won") closedWon++;
          if (lead.status === "Closed Lost" || lead.status === "Not a Fit") closedLost++;

          // timeline-based stats
          for (const entry of lead.timeline || []) {
            totalCallLogs++;
            const ts = new Date(entry.timestamp);

            // Today snapshot
            if (isSameDay(ts, today)) {
              callsToday++;
              if (entry.outcome === "Booked Meeting") meetingsToday++;
            }

            // Lifetime meetings
            if (entry.outcome === "Booked Meeting") {
              lifetimeMeetings++;
            }
          }

          // follow-ups due today or earlier
          if (lead.nextCall) {
            const n = new Date(lead.nextCall);
            if (!isNaN(n.getTime())) {
              const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
              const nextStart = new Date(n.getFullYear(), n.getMonth(), n.getDate());
              if (
                nextStart <= todayStart &&
                ["Working", "Follow-Up", "No Answer", "Left Voicemail"].includes(lead.status)
              ) {
                dueFollowUps++;
              }
            }
          }
        }

        // Today snapshot
        document.getElementById("crm-today-calls").textContent = callsToday.toString();
        document.getElementById("crm-today-meetings").textContent = meetingsToday.toString();
        document.getElementById("crm-today-followups").textContent = dueFollowUps.toString();

        // Analytics
        const avgCalls =
          totalLeads > 0 ? (totalCallLogs / totalLeads).toFixed(1) : "0.0";

        const elTotal = document.getElementById("crm-analytics-total");
        const elActive = document.getElementById("crm-analytics-active");
        const elLtmMeetings = document.getElementById("crm-analytics-ltm-meetings");
        const elClosedWon = document.getElementById("crm-analytics-closed-won");
        const elClosedLost = document.getElementById("crm-analytics-closed-lost");
        const elAvgCalls = document.getElementById("crm-analytics-avg-calls");

        if (elTotal) elTotal.textContent = totalLeads.toString();
        if (elActive) elActive.textContent = activePipeline.toString();
        if (elLtmMeetings) elLtmMeetings.textContent = lifetimeMeetings.toString();
        if (elClosedWon) elClosedWon.textContent = closedWon.toString();
        if (elClosedLost) elClosedLost.textContent = closedLost.toString();
        if (elAvgCalls) elAvgCalls.textContent = avgCalls.toString();
      }

      // --- Event wiring ---
      document.addEventListener("DOMContentLoaded", function () {
        renderTodayLabel();
        // refresh Today every 60s
        setInterval(renderTodayLabel, 60000);

        loadLeads();

        async function refreshAuthState() {
  const { data } = await supabaseClient.auth.getUser();
  currentUser = data.user || null;

  const statusEl = document.getElementById("crm-auth-status");
  const loggedOut = document.getElementById("crm-auth-logged-out");
  const loggedIn = document.getElementById("crm-auth-logged-in");
  const emailLabel = document.getElementById("crm-auth-email-label");

  if (currentUser) {
    statusEl.textContent = "Signed in";
    loggedOut.style.display = "none";
    loggedIn.style.display = "flex";
    emailLabel.textContent = currentUser.email || "";
    // Load leads from Supabase instead of localStorage
    await loadLeadsFromSupabase();
  } else {
    statusEl.textContent = "Not signed in";
    loggedOut.style.display = "flex";
    loggedIn.style.display = "none";
    leads = [];
    renderLeadList();
    updateCountsAndSnapshot();
  }
}

document.getElementById("crm-auth-login").addEventListener("click", async () => {
  const email = document.getElementById("crm-auth-email").value.trim();
  const password = document.getElementById("crm-auth-password").value;

  if (!email || !password) {
    alert("Enter email and password.");
    return;
  }

  const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
  if (error) {
    alert("Login failed: " + error.message);
    return;
  }
  currentUser = data.user;
  await refreshAuthState();
});

document.getElementById("crm-auth-logout").addEventListener("click", async () => {
  await supabaseClient.auth.signOut();
  currentUser = null;
  await refreshAuthState();
});

// On first load
refreshAuthState();


        // Default From/To to today
        const todayIso = getTodayISODate();
        const fromEl = document.getElementById("crm-callview-from");
        const toEl = document.getElementById("crm-callview-to");
        if (fromEl) fromEl.value = todayIso;
        if (toEl) toEl.value = todayIso;

        // Calling View toggle show/hide
        const callingToggleEl = document.getElementById("crm-calling-toggle");
        const callingRangeEl = document.getElementById("crm-calling-range");
        if (callingToggleEl && callingRangeEl) {
          callingToggleEl.addEventListener("change", function () {
            callingRangeEl.style.display = this.checked ? "flex" : "none";
            renderLeadList();
          });
        }

        // Re-render when From/To change
        if (fromEl) fromEl.addEventListener("change", renderLeadList);
        if (toEl) toEl.addEventListener("change", renderLeadList);

        renderLeadList();
        updateCountsAndSnapshot();

        // Form submit
        document.getElementById("lead-form").addEventListener("submit", async function (e) {
          e.preventDefault();
          // Require authentication before saving
          if (!currentUser) {
            alert("Please sign in first.");
            return;
          }

          const id = document.getElementById("lead-id").value || crypto.randomUUID();

          const existingIndex = leads.findIndex((l) => l.id === id);
          const base = existingIndex >= 0 ? leads[existingIndex] : {};

          const firstName = document.getElementById("lead-first-name").value.trim();
          const lastName = document.getElementById("lead-last-name").value.trim();
          const combinedName = [firstName, lastName].filter(Boolean).join(" ");

          const lead = {
            ...base,
            id,
            firstName,
            lastName,
            name: combinedName || base.name || "",
            company: document.getElementById("lead-company").value.trim(),
            phone: document.getElementById("lead-phone").value.trim(),
            email: document.getElementById("lead-email").value.trim(),
            website: document.getElementById("lead-website").value.trim(),
            source: document.getElementById("lead-source").value.trim(),
            status: document.getElementById("lead-status").value,
            priority: document.getElementById("lead-priority").value,
            timezone: document.getElementById("lead-timezone").value,
            nextCall: document.getElementById("lead-next-call").value,
            notes: document.getElementById("lead-notes").value.trim(),
            createdAt: base.createdAt || new Date().toISOString(),
            updatedAt: new Date().toISOString(),
            timeline: base.timeline || []
          };

          if (existingIndex >= 0) {
            leads[existingIndex] = lead;
          } else {
            leads.push(lead);
          }

          await upsertLeadToSupabase(lead);
          renderLeadList();
          selectLead(id);
        });

        // Reset form
        document.getElementById("crm-form-reset").addEventListener("click", function () {
          resetForm();
        });

        // Filters
        document.getElementById("crm-search").addEventListener("input", renderLeadList);
        document.getElementById("crm-filter-status").addEventListener("change", renderLeadList);
        document.getElementById("crm-filter-priority").addEventListener("change", renderLeadList);

        // Call outcome buttons
        document.querySelectorAll(".crm-call-outcome").forEach((btn) => {
          btn.addEventListener("click", async function () {
            const noteEl = document.getElementById("crm-call-note");
            const outcome = this.dataset.outcome;
            if (!selectedId) {
              alert("Select a lead first.");
              return;
            }

            const nextCallVal = document.getElementById("crm-call-next").value;

            const idx = leads.findIndex((l) => l.id === selectedId);
            if (idx < 0) return;
            const lead = leads[idx];
            lead.timeline = lead.timeline || [];
            lead.timeline.push({
              timestamp: new Date().toISOString(),
              outcome,
              note: noteEl.value.trim()
            });

            // Auto-update status on some outcomes
            if (outcome === "Booked Meeting") {
              lead.status = "Booked Meeting";
            } else if (outcome === "Not Interested") {
              lead.status = "Not a Fit";
            } else if (outcome === "No Answer") {
              lead.status = "No Answer";
            } else if (outcome === "Left Voicemail") {
              lead.status = "Left Voicemail";
            } else if (outcome === "Callback Requested") {
              lead.status = "Follow-Up";
            }

            if (nextCallVal) {
              lead.nextCall = nextCallVal;
              document.getElementById("lead-next-call").value = nextCallVal;
            }

            lead.updatedAt = new Date().toISOString();

            leads[idx] = lead;
            await upsertLeadToSupabase(lead);
            renderLeadList();
            selectLead(lead.id);
          });
        });

        // "Save Log" button (note-only / manual update)
        document.getElementById("crm-call-save").addEventListener("click", async function () {
          if (!selectedId) {
            alert("Select a lead first.");
            return;
          }
          const note = document.getElementById("crm-call-note").value.trim();
          const nextCallVal = document.getElementById("crm-call-next").value;

          if (!note && !nextCallVal) {
            alert("Add a note or set a next call time before saving.");
            return;
          }

          const idx = leads.findIndex((l) => l.id === selectedId);
          if (idx < 0) return;
          const lead = leads[idx];

          lead.timeline = lead.timeline || [];
          lead.timeline.push({
            timestamp: new Date().toISOString(),
            outcome: "Update",
            note
          });

          if (nextCallVal) {
            lead.nextCall = nextCallVal;
            document.getElementById("lead-next-call").value = nextCallVal;
          }

          lead.updatedAt = new Date().toISOString();
          leads[idx] = lead;

          await upsertLeadToSupabase(lead);
          renderLeadList();
          selectLead(lead.id);
        });

        // Export JSON
        document.getElementById("crm-export").addEventListener("click", function () {
          const dataStr =
            "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(leads, null, 2));
          const a = document.createElement("a");
          a.setAttribute("href", dataStr);
          a.setAttribute("download", "impacta-calling-crm.json");
          document.body.appendChild(a);
          a.click();
          a.remove();
        });

        // Reporting modal open/close
        const reportOpenBtn = document.getElementById("crm-report-open");
        const reportCloseBtn = document.getElementById("crm-report-close");
        const reportBackdrop = document.getElementById("crm-report-modal");

        if (reportOpenBtn) {
          reportOpenBtn.addEventListener("click", renderReportModal);
        }
        if (reportCloseBtn) {
          reportCloseBtn.addEventListener("click", hideReportModal);
        }
        if (reportBackdrop) {
          reportBackdrop.addEventListener("click", function (e) {
            if (e.target === reportBackdrop) hideReportModal();
          });
        }
      });
    })();
  </script>

</body>
</html>
